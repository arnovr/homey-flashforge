<script>
    function isValidCheckCode(code) {
        return /^[A-Za-z0-9]{8}$/.test(code);
    }

    document.getElementById('next-button').addEventListener('click', async () => {
        event.preventDefault();
        const nextButton = document.getElementById('next-button');
        const checkCode = document.getElementById('check_code').value.trim();
        const error = document.getElementById('error');

        if (!isValidCheckCode(checkCode)) {
            error.textContent = 'Invalid check code. Use exactly 8 alphanumeric characters.';
            return;
        }
        
        nextButton.classList.add('is-loading' ,'is-disabled');
        nextButton.disabled = true; // Optional: prevent double clicks

        try {
            const result = await Homey.emit('saveDevice', { checkCode });

            if (!result || result.error) {
                // Optional: you can use a convention where `result.error` is returned by Homey backend
                error.textContent = result.error || 'Failed to save device.';
                return;
            }
        } catch (e) {
            console.error('Save device failed:', e);
            error.textContent = e.message || 'Something went wrong while saving the device.';
        } finally {
            // Remove loading state
            nextButton.classList.remove('is-loading', 'is-disabled');
            nextButton.disabled = false;
        }
    });

    Homey.on("createDevice", (device) => {
        Homey.createDevice(device)
            .then(function (result) {
                Homey.done();
            })
            .catch(function (error) {
                Homey.alert(error);
            });
    })
</script>

<div>
    <header class="homey-header">
        <h1 class="homey-title" data-i18n="settings.title"></h1>
        <p class="homey-subtitle" data-i18n="settings.subtitle"></p>
    </header>
    <form class="homey-form">
        <div class="homey-form-group">
            <label class="homey-form-label" for="check_code" data-i18n="settings.check_code"></label>
            <input class="homey-form-input" id="check_code" name="check_code" placeholder="Enter 8-character code"
                type="text" maxlength="8" pattern="[A-Za-z0-9]{8}" />
            <div id="error" class="homey-form-error" style="color: red; margin-top: 4px;"></div>

        </div>
        <button id="next-button" class="homey-button-primary-full" data-i18n="settings.add_device"></button>
    </form>
</div>